<form id="permissions_form">
<input type="hidden" name="permission_id">

<div class='title'>Permissions</div>
<div class='subtitle'>Permissions maintenance and administration</div><br>

<table cellspacing='10' width='100%'>
<tr>
<td class='rotateText'><div><p>^^[Info]^^</p></div></td>
<td>

    <table cellpadding="4" cellspacing="0">
    <tr><td><label>^^[Name]^^</label></td><td><input type="text" name="permission_name" style="width:350px"></td></tr>
    <tr><td><label>^^[Hierarchy]^^</label></td><td><select name="permission_order" style="width:350px"><option value="6">^^[None]^^</option><option value="5">^^[Copper]^^</option><option value="4">^^[Bronze]^^</option><option value="3">^^[Silver]^^</option><option value="2">^^[Gold]^^</option><option value="1">^^[Diamond]^^</option></select></td></tr>
    <tr><td><label>^^[Superuser]^^</label></td><td><select name="global_user" style="width:350px" onchange="permissions_superuser()"><option value="0">^^[No]^^</option><option value="1">^^[Yes]^^</option></select></td></tr>
    <tr><td><label>^^[Status]^^</label></td><td><select type="text" name="permission_status" style="width:350px"><option value="1">^^[Enabled]^^</option><option value="0">^^[Disabled]^^</option></select></td></tr>
    </table>

    <p><input type="button" name="save" value="^^[Save]^^" style="width:90px;"> <input type="reset" value="^^[New]^^" style="width:90px;" onclick="permissions_new();"></p>

</td>
</tr>
<tr id="permission_tr">
<td class='rotateText'><div><p>^^[Permissions]^^</p></div></td>
<td>

    <div id="permission_actions" style="padding:10px;min-height:100px;"></div>

</td>
</tr>
</table>
</form>

<div style="padding:10px;"><div class="grid" id="permissions_form_grid"></div></div>

<script>
var permission_id = 0;

$(document).ready(function() {
    
    $('#permissions_form').form({ url: '/admin/permissions', primarykey:'permission_id' });

    $('#permissions_form_grid').grid({
        url: '/admin/permissions/grid',
        columns:[
            {title:'^^[ID]^^',width:'40'},
            {title:'^^[Name]^^',width:'*', search:'1'},
            {title:'^^[Status]^^',width:'100', search:'2', search_combo:{'1':'^^[Active]^^','0':'^^[Inactive]^^'}},
            {title:'',width:'40'}
            ],
        actions:[
            {title:'^^[Open]^^',icon:'img/open.png',click:'permissions_open'},
            {title:'^^[Delete]^^',icon:'img/delete.png',click:'permissions_delete'}
            ]
    });
});

function permissions_new ()
{
    $('#permissions_form').form('open', '0', function (result) {
        permissions_superuser();
        permissions_routes(result.permission_routes);
    });
}

function permissions_open (id)
{
    $('#permissions_form').form('open', id, function (result) {
        permissions_superuser();
        permissions_routes(result.permission_routes);
    });
}

function permissions_routes(restrictions)
{
    var html = "<table cellpadding='2' cellspacing='0'>";
    html += "<tr>";
    html += " <td><b>^^[Route]^^</b></td><td><b>^^[Action]^^</b></td><td><b>^^[Permission]^^</b></td>";
    html += "</tr>";

    var color = '';
    var bgcolor = '';

    $.each(restrictions, function (k, v) {
        selected = v.checked ? ' selected' : '';
        title = v.title ? v.title : '';
        color = selected ? 'green' : 'red';
        bgcolor = (bgcolor == 'eee') ? 'fff' : 'eee';

        html += "<tr style='background-color:#" + bgcolor + ";color:" + color + "'>";
        html += " <td width='120'>" + k + "</td><td width='280'>" + title + "</td>";
        html += " <td>";
        html += "  <select name='permission_routes[" + k + "]' onchange=\"updateColor(this)\">";
        html += "   <option value='0'>^^[No]^^</option>";
        html += "   <option value='1'" + selected + ">^^[Yes]^^</option>";
        html += "  </select>";
        html += " </td>";
        html += "</tr>";
    });

    html += "</table>";

    $('#permission_actions').html(html);
}

function permissions_delete (id)
{
    if (confirm('^^[Are you sure]^^?'))
    {
        $('#permissions_form').form('delete', id);
    }
}

function permissions_superuser ()
{
    var o = $('#permissions_form').find('[name="global_user"]').val();

    if (o == 1) {
        $('#permission_actions').find('input').attr("disabled", "true");
        $('#permission_tr').css('display', 'none');
    } else {
        $('#permission_actions').find('input').removeAttr("disabled");
        $('#permission_tr').css('display', '');
    }
}

function updateColor (obj) {
    if ($(obj).val() == 0) {
        $(obj).parent().parent().css('color', 'red');
    } else {
        $(obj).parent().parent().css('color', 'green');
    }
}
</script>