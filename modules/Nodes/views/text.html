<form method='post' action='/nodes/<?php echo $this->view['node_id']; ?>/edition'>
<input type="hidden" name="parent_id" value="<?php echo $this->view['parent_id']; ?>">
<input type="hidden" name="type" value="<?php echo $this->view['type']; ?>">

<div class='title'>^^[Text]^^</div>
<div class='subtitle'>^^[Content administration]^^</div><br>

<table cellspacing='10'>
<tr>
<td class='rotateText'><div><p>^^[Info]^^</p></div></td>
<td>

    <table cellpadding='4'>
    <tr>
        <td><label>^^[Format]^^</label></td><td>
            <select name="format" style="width:240px;" onchange="nodes_template_custom()">
            <option value="0">^^[Default]^^</option>
            <option value="1">^^[Text with index]^^</option>
            <option value="2">^^[Article]^^</option>
            <option value="99">^^[Custom]^^</option>
            </select>
        </td>
    </tr>
    <tr><td><label>^^[URL]^^</label></td><td><div style="position:absolute;"><div style="position:relative;padding:4px;padding-right:0px;color:#555" id="nodes_link_div"><?php echo $this->view['domain']; ?></div></div><input type="text" name="link" id="nodes_link" value="<?php echo $this->view['link']; ?>" style="width:450px;"></div></td><td><input type='button' value='Open' onclick="window.open('/' + $('#nodes_link').val(), '_new');"></tr>
    <tr><td><label>^^[Title]^^</label></td><td><input type="text" name="title" style="width:450px;"></td></tr>
    <tr class='advanced' style='display:nonex;'><td><label>^^[Legend]^^</label></td><td><input name="legend" style="width:450px;"></td></tr>
    <tr><td><label>^^[Author]^^</label></td><td><input type="text" name="author" style="width:450px;"></td></tr>
    <tr><td><label>^^[Meta title]^^</label></td><td><input name="page" style="width:450px;"></td></tr>
    <tr><td><label>^^[Meta description]^^</label></td><td><input name="description" style="width:450px;"></td></tr>
    <tr><td><label>^^[Meta Keywords]^^</label></td><td><textarea name="keywords" id="nodes_keywords" style="width:400px;"></textarea></td></tr>
    <tr class='advanced' style='display:nonex;'><td><label>^^[Published From]^^</label></td><td><input type="text" name="published_from" id="nodes_published_from" style="width:240px;"></td></tr>
    <tr class='advanced' style='display:nonex;'><td><label>^^[Published To]^^</label></td><td><input type="text" name="published_to" id="nodes_published_to" style="width:240px;"></td></tr>
    <tr><td><label>^^[Status]^^</label></td><td><select name="status" style="width:240px;"><option value='1'>^^[Enabled]^^</option><option value='0'>^^[Disabled]^^</option><option value='2'>^^[Not published]^^</option></select></td></tr>
    <tr><td></td><td style='display:none;'><a onclick="$('.advanced').css('display', ''); $(this).remove();" style='cursor:pointer;color:blue;text-decoration:underline;'>^^[Advanced]^^</a></td></tr>
    </table>

</td>
</tr>
<tr class='advancedx' style='display:none;'>
<td class='rotateText'><div><p>^^[Relations]^^</p></div></td>
<td valign="top" style="padding:6px;">

    <div id='route_nodes' class='drop' style='min-height:100px;'>
        <table cellpadding="6" cellspacing="0" id="route_content_table"></table>
        <i style='padding:10px' id='routes_help'>(^^[drag a node from the tree and drop in this area]^^)</i>
    </div>

</td>
</tr>
<tr class='node_template' style='display:none;'>
<td class='rotateText'><div><p>^^[Template]^^</p></div></td>
<td valign="top" style="padding:6px;">

    <textarea name="template" style="width:100%;height:250px;"></textarea><br>  

</td>
</tr>
<tr>
<td class='rotateText'><div><p>^^[Summary]^^</p></div></td>
<td valign="top" style="padding:6px;">

    <textarea id="editor1" name="summary"></textarea>

</td>
</tr>
<tr>
<td class='rotateText'><div><p>^^[Content]^^</p></div></td>
<td valign="top" style="padding:6px;">

    <textarea id="editor2" name="content"></textarea>

</td>
</tr>
<tr>
<td class='rotateText'><div><p>Images</p></div></td>
<td>
     <div>
          <input type="file" id="file" multiple="multiple" /><br><br>

          <div id='files'></div>
     </div>
</td>
</tr>
<tr>
<td></td>
<td>
    <input type="submit" value="^^[Save]^^" onclick="nodes_save();" style="width:120px;">
    <input type="button" value="^^[New]^^" onclick="window.open('/nodes/0/edition', '_top');" style="width:120px;">
</td>
</tr>
</table>
</form>

<script>
$(document).ready(function() {

    var data = <?php echo isset($this->view['node_json']) && $this->view['node_json'] ? $this->view['node_json'] : "''"; ?>;

    if (data) {
        $.each(data, function(k, v) {
            if (k == 'files') {
                $.each(v, function(k1, v1) {
                    content = '<div class="thumbs"><img src=' + v1.thumbs + '><input type="hidden" name="files['+k1+'][mineType]" value="' + v1.mineType + '"><input type="hidden" name="files['+k1+'][extension]" value="' + v1.extension + '"><textarea name="files['+k1+'][thumbs]" style="display:none;">' + v1.thumbs + '</textarea><textarea name="files['+k1+'][content]" style="display:none;">' + v1.content + '</textarea></div>';
                    $('#files').append(content);
                });
            } else {
	            $('[name='+k+']').val(v);
            }
        });
    }

    nodes_template_custom();

    CKEDITOR.config.autoParagraph = false;

    CKEDITOR.replace( 'editor1', {
        height:150,
        extraPlugins: 'pastebase64',
        toolbar: [
            { name: 'document', items: [ 'Source', '-', 'NewPage', 'Preview', '-', 'Templates' ] },
            [ 'Cut', 'Copy', 'Paste', 'PasteText', 'PasteFromWord', '-', 'Undo', 'Redo' ],
            { name: 'basicstyles', groups: [ 'basicstyles', 'cleanup' ], items: [ 'Bold', 'Italic', 'Strike', '-', 'RemoveFormat' ] },
        ]
    });

    CKEDITOR.replace( 'editor2', {
        height:300,
        extraPlugins: 'pastebase64,font',
        stylesSet: [
            { name: 'Title' , element: 'h1', attributes: { 'class': 'title' } },
            { name: 'Red Title' , element: 'h3', styles: { 'color': 'Red' } },
            { name: 'Code block', element: 'pre', attributes: { 'class': 'prettyprint' }, styles: { 'padding': '20px' } },
            { name: 'Yellow Marker', element: 'span', styles: { 'background-color': 'Yellow' } },
            { name: 'Notes', element: 'div', styles: { 'border-radius':'10px;', 'padding':'20px', 'background-color':'#c7eaff', 'color':'#000;' } } 
        ],
        extraAllowedContent: { '$1': { attributes:'alt,itemprop,itemtype,itemscope,class,valign,style' } },
        filebrowserImageBrowseUrl: '/nodes/edition/images'
    });

    $('#nodes_published_from').calendar({ format:'dd/mm/YYYY HH24:MI' });
    $('#nodes_published_to').calendar({ format:'dd/mm/YYYY HH24:MI' });
    $('#nodes_link').css('padding-left', $('#nodes_link_div').width()+3);
    $('#nodes_keywords').tagEditor({ placeholder:'^^[Keywords]^^...', height:40 });
    

    // Files management
    $("#file").change(function(){
        // Pre-process images
        nodes_files(this.files);
        // Reset file entry
        $(this).val('');
    });

    $("#files").bind('dragstart', false);
    $("#files").bind('dragenter dragover', false); 
    $("#files").bind('drop', function(event) {
        event.preventDefault();  
        event.stopPropagation();
        var data = event.originalEvent.dataTransfer.getData('text/html');
        if (! data) {
            nodes_files(event.originalEvent.dataTransfer.files);
        } else {
            importImage('/nodes/url?url=' + $(data).attr('src'));
        }

        return false;
    });

    $('#files').on('click', function (e) {
        if ($(e.originalEvent.srcElement).prop('class') == 'thumbs') {
            if (confirm('Are you sure?')) {
                $(e.originalEvent.srcElement).remove();
            }
        }
    });
});

function nodes_template_custom()
{
    if ($('[name="format"]').val() == 99) {
        $('.node_template').css('display', '');
    } else {
        $('.node_template').css('display', 'none');
    }
}

function nodes_save()
{
    // Load text
    $('#editor1').val(CKEDITOR.instances.editor1.getData());
    $('#editor2').val(CKEDITOR.instances.editor2.getData());
}

function nodes_files(files)
{
    var reader = [];

    $.each(files, function (k, v) {
        reader[k] = new FileReader();

        reader[k].addEventListener("load", function () {
            importImage(reader[k].result);
        }, false);

        reader[k].readAsDataURL(v)
    });
}

function importImage(url)
{
    var img = new Image();

    img.onload = function() {
        var canvas = document.createElement("canvas");
        canvas.width  = 200;
        canvas.height = 200;
        var ctx = canvas.getContext("2d");
        ctx.imageSmoothingQuality = 'high';
        var w = img.width;
        var h = img.height;
        if (w > h) {
            p = 200 / w;
        } else {
            p = 200 / h;
        }
        var position = (200 - h*p) / 2;

        ctx.drawImage(img, 0, position, w*p, h*p);
        var img1 = new Image();
        var src1 = canvas.toDataURL();
        $(img1).prop('src', src1);
        var div = document.createElement('div');
        $(div).prop('class', 'thumbs');
        $(div).append(img1);

        canvas = document.createElement("canvas");
        canvas.width = img.width;
        canvas.height = img.height;
        ctx = canvas.getContext("2d");
        ctx.imageSmoothingQuality = 'high';
        ctx.drawImage(img, 0, 0);

        var l = $('#files .thumbs').length;
        var m = src1.split(';')[0].replace('data:', '');
        var e = m.split('/')[1];

		$(div).append('<input type="hidden" name="files['+l+'][mineType]" value="' + m + '"><input type="hidden" name="files['+l+'][extension]" value="' + e + '"><textarea name="files['+l+'][thumbs]" style="display:none;">' + src1 + '</textarea><textarea name="files['+l+'][content]" style="display:none;">' + canvas.toDataURL() + '</textarea>');

        $('#files').append(div);
    };

    img.src = url;
}

$(document).on('dnd_move.vakata', function (e, data) {
    var t = $(data.event.target);
    if (! t.closest('.jstree').length) {
        if (t.closest('.drop').length) {
            $('#jstree-dnd i').css('background-position', '-4px -68px');
        } else {
            $('#jstree-dnd i').css('background-position', '-36px -68px');
        }
    }
}).on('dnd_stop.vakata', function (e, data) {
    var t = $(data.event.target);
    if (! t.closest('.jstree').length) {
        if (t.closest('.drop').length) {
            id = $(data.element).prop('id').replace('_anchor', '');
            if (id > 0) {
                table = t.closest('.drop').find('#route_content_table');
                table.append(route_record(id, $('#vakata-dnd').text(), ''));
                routes_update_areas();
            } else {
                alert('^^[Invalid node]^^');
            }
        }
    }
});


function routes_update_areas ()
{
    var html = $('#template_area').html();
    var sel = $('.route_template_area');
    for (i = 0; i < sel.length; i++) {
        $(sel[i]).html(html);
        $(sel[i]).val($(sel[i]).next().val());
    }

    var html = $('#module_name').html();
    var sel = $('.route_module_name');
    for (i = 0; i < sel.length; i++) {
        v1 = $(sel[i]).next().val();
        $(sel[i]).html(html);
        $(sel[i]).val(v1);

        if (v1) {
            b = $(sel[i]).parent().parent().parent().find('.route_controller_name');
            v2 = $(b).next().val();

            $(b).html('');
            $(b).combo({ url:'/admin/routes/controllers/' + v1, value:v2 });

            if (v2) {
                url = '/admin/routes/methods/' + v1 + '/' + v2;
            } else {
                url = '/admin/routes/methods/' + v1
            }

            c = $(sel[i]).parent().parent().parent().find('.route_method_name');
            v3 = $(c).next().val();
            $(c).combo({ url:url, value:v3 });
        }
    }
}

function route_record (id, title, area, module, controller, method)
{
    var table = $('#route_content_table');
    var record = '';

    if ($(table).html() == '') {
        record = '<tr><td width="240">^^[Content to be rendered]^^</td><td>^^[HTML Container ID]^^ <span title="^^[This is a tag container in which your node content will be placed inside your HTML template, and it is identified by the id property]^^">(?)</span></td></tr>';
    }

    if (parseInt(id) > 0) {
        record += '<tr><td><table><td><i class="fa fa-clone" style="font-size:16px;"></i></td><td><span style="cursor:pointer;color:blue;text-decoration:underline;" onclick="window.open(\'/nodes/edition/' + id + '\', \'_top\')">' + title + '</span></td></table></td><td><input type="hidden" name="extra_config[module_name][]"> <input type="hidden" name="extra_config[controller_name][]"> <input type="hidden" name="extra_config[method_name][]"> <input type="text" name="extra_config[template_area][]" value="' + area + '"> <input type="hidden" name="extra_config[node_id][]" value="' + id + '"></td><td><input type="button" value="x" style="border:0px;background-color:transparent;" onclick="$(this).parent().parent().remove();"></td></tr>\n'
    } else {
        id = new Date().getTime()
        record += '<tr><td><table><td><i class="fa fa-cog" style="font-size:20px;"></i></td><td><span style="cursor:pointer;color:blue;text-decoration:underline;" onclick="$(\'#route_dialog_' + id + '\').modal();">^^[advanced config]^^</td></table></span><div id="route_dialog_' + id + '"><table><tr><td>Module</td><td><select name="extra_config[module_name][]" class="route_module_name" onchange="route_module_name_data(this)"><option value=""></option></select> <input type="hidden" value="' + module + '"></td></tr><tr><td>Controller</td><td><select name="extra_config[controller_name][]" class="route_controller_name" onchange="route_controller_name_data(this)"><option value=""></option></select> <input type="hidden" value="' + controller + '"></td></tr><tr><td>Method</td><td><select name="extra_config[method_name][]" class="route_method_name"></select> <input type="hidden" value="' + method + '"></td></tr></table><p><input type="button" value="^^[Close]^^" style="width:120px;" onclick="$(\'#route_dialog_' + id + '\').modal();"></p></div><script>$(\'#route_dialog_' + id + '\').modal({ title:\'^^[Advanced Content]^^\', closed:1, height:220 });</s' +'cript></td><td><select name="extra_config[template_area][]" class="route_template_area" style="width:240px;" onchange="$(this).next().val(this.value)"><option value=""></option></select> <input type="hidden" value="' + area + '"> <input type="hidden" name="extra_config[node_id][]"></td><td><input type="button" value="x" style="border:0px;background-color:transparent;" onclick="$(this).parent().parent().remove();"></td></tr>\n'
    }

    $('#routes_help').css('display','none');

    return record;
}

function route_module_name_data (obj)
{
    var c = $(obj).parent().parent().parent().find('.route_method_name');
    $(c).html('');
    $(c).combo({ url:'/admin/routes/methods/' + $(obj).val() });

    var c = $(obj).parent().parent().parent().find('.route_controller_name');
    $(c).html('');
    $(c).combo({ url:'/admin/routes/controllers/' + $(obj).val() });
}

function route_controller_name_data (obj)
{
    var b = $(obj).parent().parent().parent().find('.route_module_name');
    var c = $(obj).parent().parent().parent().find('.route_method_name');
    $(c).html('');
    $(c).combo({ url:'/admin/routes/methods/' + $(b).val() + '/' + $(obj).val() });
}
</script>